<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>后山论坛</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" href="./css/bootstrap.min.css">
    <script src="./js/jquery-3.4.1.min.js"></script>
    <script src="./js/bootstrap.min.js" type="application/javascript"></script>
    <link rel="stylesheet" href="./dropzone/css/dropzone.min.css">
    <script src="./dropzone/js/dropzone.min.js"></script>
    <link rel="stylesheet" href="./css/config.css">
</head>

<body>
<script src="./js/navbar.js" type="text/javascript"></script>
<div class="container-fluid main">
    <div class="row">
        <div class="col-lg-9 col-md-12 col-sm-12 main-header">
            <h3><span class="glyphicon glyphicon-list" aria-hidden="true"></span> 用户设置</h3>
        </div>
        <!-- 基本信息 -->
        <div class="mod-body">
            <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12">
                <div class="mod-head">
                    <h4>基本信息</h4>
                    <hr>
                    <form class="form-horizontal" id="setting_form">
                        <input type="text" id="id" value="" hidden>
                        <div class="form-heade">
                            <dl>
                                <dt>邮箱:</dt>
                                <dd><input type="text" class="form-control" name="email" id="email"
                                           value="" disabled="true"></dd>
                            </dl>
                            <dl>
                                <dt>昵称:</dt>
                                <dd><input type="text" class="form-control" name="accountname" id="accountname"></dd>
                            </dl>
                            <dl>
                                <dt>性别:</dt>
                                <dd id="sex">
                                    <div class="form-group col-lg-8 col-md-6 col-sm-4">
                                        <select id="status" class="form-control">
                                            <option value="男">男</option>
                                            <option value="女">女</option>
                                            <option value="保密">保密</option>
                                        </select>
                                    </div>
                                </dd>
                            </dl>
                            <br>
                            <br>
                            <dl>
                                <dt><label>个性签名:</label></dt>
                                <dd class="introduce"><input class="form-control" name="signature" id="sginName"
                                                             maxlength="128"
                                                             type="text" value=""></dd>
                            </dl>
                        </div>
                        <!-- 上传头像 -->
                        <div class="side-bar">
                            <dl>
                                <dt class="pull-left">
                                    <div id="avatar">
                                    </div>
                                </dt>
                                <dd class="pull-left">
                                    <p>支持 jpg、gif、png 等格式的图片</p>
                                    <p>不超过为3MB</p>
                                    <label for="id_avatar"><img src="./img/picture.png" alt="图像加载失败"></label>
                                    <input type="text" id="id_avatar" accept="image/png" name="file"
                                           style="display:none">
                                </dd>
                            </dl>
                        </div>
                        <!-- end 上传头像 -->
                    </form>
                </div>
                <!-- end 基本信息 -->
                <!-- 联系方式 -->
                <div class="mod-head">
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 mod-contact">
                        <div class="mod-head">
                            <h4>联系方式</h4>
                        </div>
                        <div class="mod-body clearfix">
                            <ul>
                                <li>
                                    <label for="input-qq">QQ:</label>
                                    <input class="form-control" type="text" id="input-qq" name="qq" value="">
                                </li>
                                <li>
                                    <label for="input-wechat">微信:</label>
                                    <input class="form-control" type="text" id="input-wechat" name="wechat"
                                           value="">
                                </li>
                                <li>
                                    <label for="input-mobile">手机号码:</label>
                                    <input class="form-control" type="text" id="input-mobile" name="mobile"
                                           value="">
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="mod-head">
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 mod-contact">
                        <div class="mod-head">
                            <h4>公开的联系方式</h4>
                        </div>
                        <div class="mod-body clearfix">
                            <ul>
                                <li>
                                    <label for="input-github">Github:</label>
                                    <input class="form-control" type="text" id="input-github" name="github"
                                           value="">
                                </li>
                                <li>
                                    <label for="microblog">微博:</label>
                                    <input class="form-control" type="text" id="microblog" name="microblog" value="">
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                    <button type="button" class="btn btn-success btn-lg" style="float: right" onclick="update()"
                            id="submit">
                        修改
                    </button>
                </div>
            </div>
        </div>
        <!-- 广告部分 -->
        <div class="col-lg-3 col-md-12 col-sm-12 col-xs-12">
            <div>
                <div>
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 side">
                        <h4>广告</h4>
                        <img class="img-thumbnail question-wechat" src="./picture/official-account.png">
                    </div>
                </div>
            </div>
            <hr class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <h4>赞助商家</h4>
                <a href="#" class="community-tag">阿里巴巴</a>
                <a href="#" class="community-tag">javascript</a>
                <a href="#" class="community-tag">爱美食</a>
                <a href="#" class="community-tag">好丽友</a>
                <a href="#" class="community-tag">css</a>
                <a href="#" class="community-tag">XXX</a>
                <a href="#" class="community-tag">XXX</a>
                <a href="#" class="community-tag">html5</a>
                <a href="#" class="community-tag">XXX</a>
                <a href="#" class="community-tag">XXX</a>
            </div>
            <div>
                <div>
                    <hr class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 side">
                        <a href="#" onclick="" target="_blank">
                            <img class="img-thumbnail question-wechat" src="./picture/uhost.png">
                        </a>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
<script src="./js/footer.js" type="text/javascript"></script>
<script type="text/javascript">
    var email;
    $(function () {
        $.ajax({
            url: "user/getSession",
            type: "GET",
            contentType: "application/json;charset=utf-8",
            success: function (response) {
                email = response;
                refresh();
            }
        })
    })

    function refresh() {
        $.ajax({
            url: "user/getUserConfig?email=" + email,
            type: "GET",
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (response) {
                $("#email").val(response['email']);
                $("#accountname").val(response['accountName']);
                $("#status option[value='" + response['sex'] + "']").attr("selected", true);
                $("#avatar").css("background-image", "url(static/upload/" + response['icon'] + ")");
                $("#sginName").val(response['sginName']);
                $("#input-qq").val(response['qq']);
                $("#input-wechat").val(response['weChat']);
                $("#input-mobile").val(response['mobile']);
                $("#input-github").val(response['github']);
                $("#microblog").val(response['microblog']);
            },
            error: function (response) {
            }
        })
    }

    Dropzone.autoDiscover = false;
    var fileName;
    var myDropzone = new Dropzone("#id_avatar", {
        url: "file/upload", // 文件提交地址
        method: "POST",  // 也可用put
        paramName: "multipartFile", // 默认为file
        maxFiles: 1,// 一次性上传的文件数量上限
        maxFilesize: 3, // 文件大小，单位：MB
        acceptedFiles: ".jpg,.gif,.png", // 上传的类型
        addRemoveLinks: true,
        parallelUploads: 1,// 一次上传的文件数量
        // previewsContainer:"#avatar", // 上传图片的预览窗口
        dictDefaultMessage: '拖动文件至此或者点击上传',
        dictMaxFilesExceeded: "您最多只能上传1个文件！",
        dictResponseError: '文件上传失败!',
        dictInvalidFileType: "文件类型只能是*.jpg,*.gif,*.png",
        dictFallbackMessage: "浏览器不受支持",
        dictFileTooBig: "文件过大上传文件最大支持.",
        dictRemoveLinks: "删除",
        dictCancelUpload: "取消",
        init: function () {
            this.on("addedfile", function (file) {
                // 上传文件时触发的事件
            });
            this.on("success", function (file, data) {
                // 上传成功触发的事件
                fileName = data.filename;
                $("#avatar").css("background-image", "url(static/upload/" + fileName + ")");
                updateIcon();
            });
            this.on("error", function (file, data) {
                // 上传失败触发的事件
            });
            this.on("removedfile", function (file) {
                // 删除文件时触发的方法

            });
        }
    });

    function updateIcon() {
        var json = {
            email: email,
            icon: fileName
        }
        var jsonStr = JSON.stringify(json);
        $.ajax({
            url: "file/updateIcon/",
            type: "PUT",
            contentType: "application/json;charset=utf-8",
            data: jsonStr,
            success: function (response) {
            },
            error: function (response) {
                console.error(response)
            }

        })
    }

    function update() {
        var accountnameVal = $("#accountname").val();
        var sexVal = $('#sex option:selected').val();
        var sginNameVal = $("#sginName").val();
        var qqVal = $("#input-qq").val();
        var wechatVal = $("#input-wechat").val();
        var mobileVal = $("#input-mobile").val();
        var githubVal = $("#input-github").val();
        var microblogVal = $("#microblog").val();
        var json = {
            email: email,
            accountName: accountnameVal,
            sex: sexVal,
            sginName: sginNameVal,
            icon: fileName,
            qq: qqVal,
            weChat: wechatVal,
            mobile: mobileVal,
            github: githubVal,
            microblog: microblogVal
        }
        var jsonStr = JSON.stringify(json);
        $.ajax({
            async: false,
            url: "user/updateMassge",
            type: "PUT",
            contentType: "application/json;charset=utf-8",
            data: jsonStr,
            success: function (response) {
                alert("修改成功！")
            },
            error: function (response) {
                alert("修改失败！")
            }
        })
    }

</script>
</body>
</html>