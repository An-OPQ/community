<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>求知论坛</title>
    <link rel="stylesheet" href="./css/bootstrap.min.css">
    <link rel="stylesheet" href="./css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="./css/community.css">
    <link rel="stylesheet" href="./css/config.css">
    <script src="./js/jquery-3.4.1.min.js"></script>
    <script src="./js/bootstrap.min.js" type="application/javascript"></script>
    <script src="./js/community.js" type="application/javascript"></script>
    <style>
        hr {
            margin-top: 20px;
            margin-bottom: 20px;
            border: 0;
            border-top: 1px solid #eee;
        }
    </style>
</head>
<body>
<script src="./js/navbar.js" type="text/javascript"></script>
<div class="container-fluid main profile">
    <div class="row">
        <!--左边主要内容-->
        <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12">
            <!--正文-->
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <h4 class="question-title"><span id="title">登录时获取不了token，有大佬有时间可以给看下代码问题吗微信15000823209 谢谢</span></h4>
                <span class="text-desc">
                        作者：<span class="author">wanglei</span> |
                        发布时间：<span id="createDate">2020-08-13 09:15</span> |
                        阅读数： <span id="view_count">50</span>
                                <input id="author_id" type="hidden" value=""/>
                    </span>
                <hr class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <!--内容-->
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12" id="question-view">
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 top-header">
                        <a href="#" target="_blank" style="color: #A00;font-weight: bold;">星光培训你值得拥有</a>
                        <img src="./img/hot.png">
                    </div>
                    <div id="description"></div>
                </div>
                <!--标签-->
                <hr class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <span class="question-tag">
                            <a href="#" class="community-tag" id="tag">test</a>
                        </span>
                </div>
                <!--编辑-->
                <hr class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">

                </div>
                <hr class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
            </div>

            <!--回复-->
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12" id="Reply">
                <h4>
                    <span></span> 个回复
                </h4>
                <hr class="col-lg-12 col-md-12 col-sm-12 col-xs-12 comment-sp">
                <div id="commentDescriptions">
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 comments">
                        <div class="media">
                            <div class="media-left">
                                <a href="#">
                                    <img class="media-object img-rounded"
                                         src="">
                                </a>
                            </div>
                            <div class="media-body" id="comment-body-3315">
                                <h5 class="media-heading">
                                    <span>瓦刀</span>
                                </h5>
                                <div>①通过请求参数访问Github API的方式已经被废弃，可以按照此教程修改一小段代码：https://niter.cn/p/115。
                                    ②也有可能是连接不稳定，参考这个帖子配置host ：https://niter.cn/p/125
                                    ③github服务器在国外，极其不稳定，建议多尝试几次试试，实在不行，建议放弃，使用百度等第三方登录方式。
                                </div>
                                <div class="menu">
                                    <span class="glyphicon glyphicon-thumbs-up icon"></span>
                                    <span data-id="3315" class="comment-icon">
                                        <span class="glyphicon glyphicon-comment"></span>
                                        <span>0</span>
                                    </span>
                                    <span class="pull-right">2020-08-13</span>
                                </div>
                                <!--二级评论-->
                                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 collapse sub-comments"
                                     id="comment-3315">
                                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                        <input type="text" class="form-control" placeholder="评论一下……"
                                               id="input-3315">
                                        <button type="button" class="btn btn-success pull-right"
                                                data-id="3315">评论
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!--回复输入框-->
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <h4>
                    提交回复
                </h4>
                <hr class="col-lg-12 col-md-12 col-sm-12 col-xs-12 comment-sp">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12" id="comment_section">
                    <div class="media">
                        <div class="media-left">
                            <a href="#">
                                <img class="media-object img-rounded" src="#" id="UserInfo_Icon">
                            </a>
                        </div>
                        <div class="media-body">
                            <h5 class="media-heading">
                                <span id="UserInfo_accountName"></span>
                            </h5>
                        </div>
                    </div>
                    <input type="hidden" id="user_id" value="">
                    <input type="hidden" id="question_id" value="">
                    <textarea class="form-control comment" rows="6" id="comment_content" value=""></textarea>
                    <button type="button" class="btn btn-success btn-comment" id="publishComment">回复</button>
                    </button>
                </div>
            </div>
        </div>

        <!--右边信息块-->
        <div class="col-lg-3 col-md-12 col-sm-12 col-xs-12">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <h4>发起人</h4>
                <div class="media">
                    <div class="media-left">
                        <a href="#">
                            <img class="media-object img-rounded" id="author_icon"
                                 src="">
                        </a>
                    </div>
                    <div class="media-body">
                        <h5 class="media-heading">
                            <span class="author">wanglei</span>
                        </h5>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-12 col-sm-12 col-xs-12">
            <div>
                <div>
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 side">
                        <h4>广告</h4>
                        <img class="img-thumbnail question-wechat" src="./picture/official-account.png">
                    </div>
                </div>
            </div>
            <hr class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <h4>赞助商家</h4>
                <a href="#" class="community-tag">阿里巴巴</a>
                <a href="#" class="community-tag">javascript</a>
                <a href="#" class="community-tag">爱美食</a>
                <a href="#" class="community-tag">好丽友</a>
                <a href="#" class="community-tag">css</a>
                <a href="#" class="community-tag">XXX</a>
                <a href="#" class="community-tag">XXX</a>
                <a href="#" class="community-tag">html5</a>
                <a href="#" class="community-tag">XXX</a>
                <a href="#" class="community-tag">XXX</a>
            </div>
            <div>
                <div>
                    <hr class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 side">
                        <a href="#" onclick="" target="_blank">
                            <img class="img-thumbnail question-wechat" src="./picture/uhost.png">
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="./js/footer.js"></script>
<script>
    var email;
    $(function () {
        $.ajax({
            url: "user/getSession",
            type: "GET",
            contentType: "application/json;charset=utf-8",
            success: function (response) {
                email = response;
                refresh();
                uploadUserInfo();
            }
        })
    });

    function refresh() {
        var params = window.location.search;
        var id = params.substring(params.indexOf("=") + 1)
        $.ajax({
            url: "comment/getAllComment?id=" + id,
            type: "GET",
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (response) {
                $("#author_id").empty().val(response[0].question.creatorid);
                $("#title").empty().text(response[0].question.title);
                $(".author").empty().text(response[0].accountName);
                $("#question_id").empty().val(response[0].question.id);
                $("#author_icon").attr("src", "static/upload/" + response[0].icon);
                $("#description").empty().html(response[0].question.description);
                $("#createDate").empty().text(response[0].question.createDate);
                $("#view_count").empty().text(response[0].question.viewCount);
                $("#tag").empty().text(response[0].question.tag);
                getAllCommentByQuestion();
                updateViewCount();
            },
            error: function (response) {
                console.error(response)
            }
        })
    }

    /**
     * 查询登录的用户为？
     */
    function uploadUserInfo() {
        $.ajax({
            url: "user/getUserConfig?email=" + email,
            type: "GET",
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (response) {
                $("#user_id").val(response.id)
                $("#UserInfo_Icon").attr("src", "static/upload/" + response.icon);
                $("#UserInfo_accountName").text(response['accountName']);
            },
            error: function (response) {
            }
        })
    }

    /**
     * 发布评论
     */
    $("#publishComment").click(function () {
        var creatorId = $("#user_id").val();
        var questionId = $("#question_id").val();
        var commentDescription = $("#comment_content").val();
        var date = new Date();
        var Month = date.getMonth() + 1;
        var commentDate = date.getFullYear() + "-" + Month + "-" + date.getDate();
        var json = {
            creatorId: creatorId,
            questionId: questionId,
            commentDescription: commentDescription,
            commentDate: commentDate
        }
        var jsonStr = JSON.stringify(json)
        $.ajax({
            url: "comment/publishComment",
            type: "POST",
            data: jsonStr,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (response) {
                updateCommentCount();
                window.location.reload()
            },
            error: function (response) {
                console.error(response)
            }
        })
    })


    function getAllCommentByQuestion() {
        var Id = $("#question_id").val();
        $.ajax({
            url: "comment/getAllCommentByQuestion?questionId=" + Id,
            type: "GET",
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (response) {
                var commentDescriptions = $("#commentDescriptions")
                commentDescriptions.empty();
                $("#Reply span").text(response.length)
                for (let i = 0; i < response.length; i++) {
                    var comment = response[i];
                    var bodyStr = "";
                    bodyStr += "<div id=\"commentDescription\">\n" +
                        "   <div class=\"col-lg-12 col-md-12 col-sm-12 col-xs-12 comments\">\n" +
                        "       <div class=\"media\">\n" +
                        "           <div class=\"media-left\">\n";
                    if (comment.icon != null && comment.icon != undefined) {
                        bodyStr += "<a href=\"#\">\n" +
                            "      <img class=\"media-object img-rounded\"\n" +
                            "         src=\"static/upload/" + comment.icon + "\">\n" +
                            "   </a>\n";
                    } else {
                        bodyStr += "<a href=\"#\">\n" +
                            "   <img class=\"media-object img-rounded\"\n" +
                            "     src=\"./img/25213266.png\">\n" +
                            " </a>\n";
                    }
                    bodyStr += "</div>\n" +
                        "           <div class=\"media-body\" id=\"comment-body-3315\">\n" +
                        "               <h5 class=\"media-heading\">\n" +
                        "                   <span>" + comment.accountName + "</span>\n" +
                        "               </h5>\n" +
                        "               <div>" + comment.comment.commentDescription + "</div>\n" +
                        "               <div class=\"menu\">\n" +
                        "                   <span data-id=\"3316\" class=\"comment-icon\" onclick='LikeCount(this)'>\n" +
                        "                    <input type=\"hidden\" class=\"commentId\" value=\"" + comment.comment.id + "\">\n" +
                        "                       <span class=\"glyphicon glyphicon-thumbs-up icon\"></span>\n" +
                        "                       <span id=\'cLikeCount\' >" + comment.comment.likeCount + "</span>\n" +
                        "                   <span data-id=\"3315\" class=\"comment-icon\">\n" +
                        "                       <span class=\"glyphicon glyphicon-comment\"></span>\n" +
                        "                       <span>" + comment.comment.commentCount + "</span>\n" +
                        "                   </span>\n" +
                        "                   <span class=\"pull-right\">" + comment.comment.commentDate + "</span>\n" +
                        "               </div>\n" +
                        "           </div>\n" +
                        "         </div>\n" +
                        "     </div>\n" +
                        " </div>"
                    commentDescriptions.append(bodyStr);
                }
            },
            error: function (response) {
                console.error(response)
            }
        })
    }

    function updateViewCount() {
        var id = $("#question_id").val();
        $.ajax({
            url: "publish/updateViewCount?id=" + id,
            type: "PUT",
            contentType: "application/json;charset=utf-8",
            success: function (response) {
                if (response) {
                    var viewCount = $("#view_count").html();
                    var count = parseInt(viewCount) + 1;
                    $("#view_count").html(count);
                }
            },
            error: function (response) {
                console.error(response)
            }
        })
    }

    function updateCommentCount() {
        var id = $("#question_id").val();
        $.ajax({
            url: "publish/updateCommentCount?id=" + id,
            type: "PUT",
            contentType: "application/json;charset=utf-8",
            success: function (response) {
            },
            error: function (response) {
                console.error(response)
            }
        })
    }


    function LikeCount(obj) {
        var id = $(obj).find("input").val();
        if ($(obj).find(".icon").css("color") == 'rgb(153, 153, 153)') {
            $.ajax({
                url: "publish/addLikeCount?id=" + id,
                type: "PUT",
                contentType: "application/json;charset=utf-8",
                success: function (response) {
                    if (response) {
                        var cLikeCount = $(obj).find("#cLikeCount").html();
                        var count = parseInt(cLikeCount) + 1;
                        $(obj).find("#cLikeCount").html(count);
                        $(obj).find(".icon").css("color", 'rgb(255, 0, 0)')
                    }

                },
                error: function (response) {
                    console.error(response)
                }
            })
        } else if ($(obj).find(".icon").css("color") == 'rgb(255, 0, 0)') {
            $.ajax({
                url: "publish/lessLikeCount?id=" + id,
                type: "PUT",
                contentType: "application/json;charset=utf-8",
                success: function (response) {
                    if (response) {
                        var cLikeCount = $(obj).find("#cLikeCount").html();
                        var count = parseInt(cLikeCount) - 1;
                        $(obj).find("#cLikeCount").html(count);
                        $(obj).find(".icon").css("color", 'rgb(153, 153, 153)')
                    }

                },
                error: function (response) {
                    console.error(response)
                }
            })
        }
    }


</script>
</body>
</html>