<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>求知论坛</title>
    <link rel="stylesheet" href="./css/bootstrap.min.css">
    <link rel="stylesheet" href="./css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="./css/community.css">
    <link rel="stylesheet" href="./css/config.css">
    <link href="./img/favicon.ico" rel="icon">
    <script src="./js/jquery-3.4.1.min.js"></script>
    <script src="./js/bootstrap.min.js" type="application/javascript"></script>
    <script src="./js/community.js" type="application/javascript"></script>
    <link rel="stylesheet" href="./wangEditor/wangEditor.min.css">
    <script src="./wangEditor/wangEditor.min.js"></script>
    <link href="./img/favicon.ico" rel="icon">
    <style>
        hr {
            margin-top: 20px;
            margin-bottom: 20px;
            border: 0;
            border-top: 1px solid #eee;
        }

        .modal-dialog, .modal-content {
            top: 10%;
            width: 1000px;
            height: 600px;
            margin: 0 auto;
        }

        .modal-content label {
            font-size: 14px;
        }

        .label {
            padding: 5px;
        }

        .label-danger {
            opacity: 0.5;
        }

        .label-info {
            background-color: #fff;
            border: 1px solid #f5f5f5;
            border-radius: 4px;
            opacity: 0.7;
            color: #999;
        }

        .commentDescriptionVal {
            margin: 15px 0 15px 10px;
        }

        .label-default {
            opacity: 0.7;
            background-color: #499ef3;
        }

        .menu {
            margin-bottom: 10px;
        }

        .menuLevel2 {
            margin-top: 20px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<script src="./js/navbar.js" type="text/javascript"></script>
<div class="container-fluid main profile">
    <div class="row">
        <!--左边主要内容-->
        <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12">
            <!--正文-->
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <h4 class="question-title"><span id="title"></span></h4>
                <span class="text-desc">
                        作者：<span class="author"></span> |
                        发布时间：<span id="createDate"></span> |
                        阅读数： <span id="view_count"></span>
                                <input id="author_id" type="hidden" value=""/>
                    </span>
                <hr class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <!--内容-->
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12" id="question-view">
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 top-header">
                    </div>
                    <div id="description"></div>
                </div>
                <!--编辑-->
                <hr class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12" id="updateQuestion">
                    <div class="pull-right likeModel">
                        <span class="label label-success" role="button" onclick="like(this)">
                            <span class="glyphicon glyphicon-thumbs-up">&thinsp;顶</span>
                        </span>&nbsp;
                        <span class="label label-warning" role="button" onclick="like(this)">
                            <span class="glyphicon glyphicon-thumbs-down">&thinsp;踩</span>
                        </span>
                    </div>
                </div>
                <hr class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
            </div>
            <!--回复-->
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12" id="Reply">
                <h4>
                    <span></span> 个回复
                </h4>
                <hr class="col-lg-12 col-md-12 col-sm-12 col-xs-12 comment-sp">
                <div id="commentDescriptions">
                </div>
            </div>
            <!--回复输入框-->
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <h4>
                    提交回复
                </h4>
                <hr class="col-lg-12 col-md-12 col-sm-12 col-xs-12 comment-sp">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12" id="comment_section">
                    <div class="media">
                        <div class="media-left">
                            <a href="#">
                                <img class="media-object img-rounded" src="#" id="UserInfo_Icon">
                            </a>
                        </div>
                        <div class="media-body">
                            <h5 class="media-heading">
                                <span id="UserInfo_accountName"></span>
                            </h5>
                        </div>
                    </div>
                    <input type="hidden" id="user_id" value="">
                    <input type="hidden" id="question_id" value="">
                    <textarea class="form-control comment" rows="6" id="comment_content"></textarea>
                    <button class="btn btn-success btn-comment" id="commentSubmit">回复</button>
                </div>
            </div>
        </div>
        <br>
        <!--右边信息块-->
        <div class="col-lg-3 col-md-12 col-sm-12 col-xs-12">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <h4>发起人</h4>
                <div class="media">
                    <div class="media-left">
                        <a href="#">
                            <img class="media-object img-rounded" id="author_icon"
                                 src="">
                        </a>
                    </div>
                    <div class="media-body">
                        <h5 class="media-heading">
                            <span class="author"></span>
                        </h5>
                    </div>
                </div>
            </div>
        </div>
        <!--广告部分-->
        <div class="col-lg-3 col-md-12 col-sm-12 col-xs-12">
            <div>
                <div>
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12 side">
                        <h4>广告</h4>
                        <a href="#" onclick="" target="_blank">
                            <img class="img-thumbnail advertImg" src="">
                        </a>
                    </div>
                </div>
            </div>
            <hr class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <h4>赞助商家</h4>
                <a href="#" class="community-tag sponsor" target="_blank">阿里巴巴</a>
            </div>
        </div>
    </div>
</div>
<!--编辑弹出框-->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">×</span></button>
                <h4 class="modal-title" id="myEditModalLabel"><span class="glyphicon glyphicon-edit"></span> 编辑</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="select_model">选择板块:</label>
                    <select class="select_model input-sm" id="select_model" style="margin-right: 300px; width: 150px;">
                        <option value="1">科学技术</option>
                    </select>
                    <label for="title">标题:</label>
                    <input id="edit_title" placeholder="请输入帖子标题，不超过30字" minlength="2" maxlength="30" class="input-sm"
                           style="width: 400px;" value="">
                </div>
                <div class="form-group" id="edit_description">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal"><span
                        class="glyphicon glyphicon-remove" aria-hidden="true"></span>关闭
                </button>
                <button type="button" id="btn_submit2" class="btn btn-primary" data-dismiss="modal"><span
                        class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span>修改
                </button>
            </div>
        </div>
    </div>
</div>
<script src="./js/footer.js"></script>
<!--加载广告-->
<script src="./js/getAdvert.js" type="text/javascript"></script>
<script src="./js/sweetalert.min.js"></script>
<script>
    $(function () {
        $("#searchSubmit").attr("disabled", "disabled");
        $("#search").attr("disabled", "disabled")
    })

    var params = window.location.search;
    //question ID
    var id = params.substring(params.indexOf("=") + 1)
    var email;
    var titleVal
    var descriptionVal
    var ModelVal
    var accountName

    /**
     * 查询登录的用户为？
     */
    $(function () {
        $.ajax({
            url: "user/getUserConfig?email=" + email,
            type: "GET",
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (response) {
                $("#user_id").val(response.id)
                $("#UserInfo_Icon").attr("src", "static/upload/" + response.icon);
                $("#UserInfo_accountName").text(response['accountName']);
            },
            error: function (response) {
            }
        })
    })

    $(function () {
        $.ajax({
            url: "user/getSession",
            type: "GET",
            contentType: "application/json;charset=utf-8",
            success: function (response) {
                email = response;
                refresh(id);
            }
        })
    });


    //加载question刷新到页面上
    function refresh(id) {
        $.ajax({
            url: "comment/getAllComment?id=" + id,
            type: "GET",
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (response) {
                $("#author_id").empty().val(response[0].question.creatorid);
                $("#title").empty().text(response[0].question.title);
                $(".author").empty().text(response[0].accountName);
                $("#question_id").empty().val(response[0].question.id);
                $("#author_icon").attr("src", "static/upload/" + response[0].icon);
                $("#description").empty().html(response[0].question.description);
                $("#createDate").empty().text(response[0].question.createDate);
                $("#view_count").empty().text(response[0].question.viewCount);
                $("#tag").empty().text(response[0].question.tag);
                titleVal = response[0].question.title
                descriptionVal = response[0].question.description
                ModelVal = response[0].question.typeid
                accountName = response[0].accountName
                getAllCommentByQuestion();
                updateViewCount();
                updateQuestion()
            },
            error: function (response) {
                console.error(response)
            }
        })
    }

    /**
     * 发布评论
     */
    $("#commentSubmit").click(function () {
        var creatorId = $("#user_id").val();
        var questionId = $("#question_id").val();
        var commentDescription = $("#comment_content").val();
        var date = new Date();
        var Month = date.getMonth() + 1;
        var commentDate = date.getFullYear() + "-" + Month + "-" + date.getDate();
        var json = {
            creatorId: creatorId,
            questionId: questionId,
            commentDescription: commentDescription,
            commentDate: commentDate
        }
        var jsonStr = JSON.stringify(json)
        $.ajax({
            url: "comment/publishComment",
            type: "POST",
            data: jsonStr,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (response) {
                if (response) {
                    updateCommentCount();
                    swal({
                        text: "发布成功",
                        icon: "success",
                    });
                    //发布评论后，然后重新查询一下评论的数据。
                    getAllCommentByQuestion();
                    $("#comment_content").val("")
                }

            },
            error: function (response) {
                console.error(response)
            }
        })
    })


    function getAllCommentByQuestion() {
        var Id = $("#question_id").val();
        $.ajax({
            url: "comment/getAllCommentByQuestion?questionId=" + Id,
            type: "GET",
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (response) {
                var commentDescriptions = $("#commentDescriptions")
                commentDescriptions.empty();
                $("#Reply span").text(response.length)
                for (let i = 0; i < response.length; i++) {
                    var comment = response[i];
                    var bodyStr = "";
                    bodyStr += "<div id=\"commentDescription\">\n" +
                        "   <div class=\"col-lg-12 col-md-12 col-sm-12 col-xs-12 comments\">\n" +
                        "       <div class=\"media\">\n" +
                        "           <div class=\"media-left\">\n";
                    if (comment.icon != null && comment.icon != undefined) {
                        bodyStr += "<a href=\"#\">\n" +
                            "      <img class=\"media-object img-rounded\"\n" +
                            "         src=\"static/upload/" + comment.icon + "\">\n" +
                            "   </a>\n";
                    } else {
                        bodyStr += "<a href=\"#\">\n" +
                            "   <img class=\"media-object img-rounded\"\n" +
                            "     src=\"./img/25213266.png\">\n" +
                            " </a>\n";
                    }
                    bodyStr += "</div>\n" +
                        "           <div class=\"media-body\">\n" +
                        "               <h5 class=\"media-heading\">\n" +
                        "                   <span class='label label-danger'>" + comment.accountName + "</span>\n" +
                        "               </h5>\n" +
                        "               <div class='commentDescriptionVal'>" + comment.comment.commentDescription + "</div>\n" +
                        "               <div class=\"menu\">\n" +
                        "                   <span data-id=\"3316\" class=\"comment-icon\">\n" +
                        "                    <input type=\"hidden\" class=\"commentId\" value=\"" + comment.comment.id + "\">\n" +
                        "                   <span class=\'label label-info\'>\n" +
                        "                       <span class=\"glyphicon glyphicon-thumbs-up\"></span>\n" +
                        "                       <span id=\'cLikeCount\' >" + comment.comment.likeCount + "</span>\n" +
                        "                   </span>&nbsp;" +
                        "                   <span class=\"label label-default\" onclick=\'secondaryComment(this,\"" + comment.comment.id + "\",\"" + comment.accountName + "\")\'>\n" +
                        "                       <span class=\"glyphicon glyphicon-comment\"></span>\n" +
                        "                       <span>" + comment.comment.commentCount + "</span>\n" +
                        "                   </span>\n" +
                        "                   <span class=\"pull-right\">" + comment.comment.commentDate + "</span>\n" +
                        "               </div>\n" +
                        "               <div id='commtentLevel2'>" +
                        "                <hr class=\"col-lg-12 col-md-12 col-sm-12 col-xs-12 comment-sp\">" +
                        "              </div>\n"+
                        "           </div>\n" +
                        "         </div>\n" +
                        "     </div>\n" +
                        " </div>"
                    commentDescriptions.append(bodyStr);
                }
            },
            error: function (response) {
                console.error(response)
            }
        })
    }

    function refreshSecondaryComment(srcEle,comID){
        // $.ajax({
        //     url: "publish/refreshSecondaryComment?id=" + id,
        //     type: "GET",
        //     contentType: "application/json;charset=utf-8",
        //     success: function (response) {
        //
        //     },
        //     error: function (response) {
        //         console.error(response)
        //     }
        // })
        console.log(srcEle)
        console.log(comID)
    }


    function updateViewCount() {
        var id = $("#question_id").val();
        $.ajax({
            url: "publish/updateViewCount?id=" + id,
            type: "PUT",
            contentType: "application/json;charset=utf-8",
            success: function (response) {
                if (response) {
                    var viewCount = $("#view_count").html();
                    var count = parseInt(viewCount) + 1;
                    $("#view_count").html(count);
                }
            },
            error: function (response) {
                console.error(response)
            }
        })
    }

    function updateCommentCount() {
        var id = $("#question_id").val();
        $.ajax({
            url: "publish/updateCommentCount?id=" + id,
            type: "PUT",
            contentType: "application/json;charset=utf-8",
            success: function (response) {

            },
            error: function (response) {
                console.error(response)
            }
        })
    }


    // function LikeCount(obj) {
    //     var id = $(obj).find("input").val();
    //     if ($(obj).find(".icon").css("color") == 'rgb(153, 153, 153)') {
    //         $.ajax({
    //             url: "publish/addLikeCount?id=" + id,
    //             type: "PUT",
    //             contentType: "application/json;charset=utf-8",
    //             success: function (response) {
    //                 if (response) {
    //                     var cLikeCount = $(obj).find("#cLikeCount").html();
    //                     var count = parseInt(cLikeCount) + 1;
    //                     $(obj).find("#cLikeCount").html(count);
    //                     $(obj).find(".icon").css("color", 'rgb(255, 0, 0)')
    //                 }
    //
    //             },
    //             error: function (response) {
    //                 console.error(response)
    //             }
    //         })
    //     } else if ($(obj).find(".icon").css("color") == 'rgb(255, 0, 0)') {
    //         $.ajax({
    //             url: "publish/lessLikeCount?id=" + id,
    //             type: "PUT",
    //             contentType: "application/json;charset=utf-8",
    //             success: function (response) {
    //                 if (response) {
    //                     var cLikeCount = $(obj).find("#cLikeCount").html();
    //                     var count = parseInt(cLikeCount) - 1;
    //                     $(obj).find("#cLikeCount").html(count);
    //                     $(obj).find(".icon").css("color", 'rgb(153, 153, 153)')
    //                 }
    //
    //             },
    //             error: function (response) {
    //                 console.error(response)
    //             }
    //         })
    //     }
    // }


    //二级评论
    function secondaryComment(srcEle, ID, accountName) {
        var objStr = " <div class=\"col-lg-12 col-md-12 col-sm-12 col-xs-12 collapse sub-comments\">\n" +
            "     <div class=\"col-lg-12 col-md-12 col-sm-12 col-xs-12\">\n" +
            "         <input type=\"text\" class=\"form-control\" placeholder=\"回复@" + accountName + " : \"/>" +
            "         <button type=\"button\" class=\"btn btn-success pull-right\" onclick=\'secondarySubmit(\"" + ID + "\",\"" + accountName + "\")\'  \n" +
            "                 data-id=\"3315\">评论\n" +
            "         </button>\n" +
            "     </div>\n" +
            "  </div>";
        var secondaryCommentObj = $(srcEle).parent().parent().next();
        if (!secondaryCommentObj.is('.active')) {
            secondaryCommentObj.addClass("active");
            if (!secondaryCommentObj.next().is('.collapse')) {
                secondaryCommentObj.parent().append(objStr)
            }
            secondaryCommentObj.next().css("display", "block")
        } else {
            secondaryCommentObj.next().css("display", "none")
            secondaryCommentObj.removeClass("active")

        }
    }

    function secondarySubmit(commentID, name) {
        var userID = $("#user_id").val()
        var commentVal = $(".sub-comments").find("input").val()
        var date = new Date();
        var Month = date.getMonth() + 1;
        var commentDate = date.getFullYear() + "-" + Month + "-" + date.getDate();
        var json = {
            comMultiUserId: userID,
            comId: commentID,
            comMultiContent: commentVal,
            comMultiTime: date
        }
        var jsonStr = JSON.stringify(json)
        $.ajax({
            url: "publish/secondarySubmit",
            type: "POST",
            data: jsonStr,
            contentType: "application/json;charset=utf-8",
            success: function (response) {
                if (response) {
                    var objStr = "";
                    objStr += "<div class=\"media-body\">\n" +
                        "    <h5 class=\"media-heading\" style='display: inline'>\n" +
                        "        <span class=\"label label-danger\">" + accountName + "</span><span style='color: lightgray'> 回复@ " + name + " : </span>\n" +
                        "    </h5>\n" +
                        "    <div class=\"commentDescriptionVal\" style='display: inline'>" + commentVal + "</div>\n" +
                        "    <div class=\"menuLevel2\">\n" +
                        "        <span class=\"comment-icon\">\n" +
                        "            <input type=\"hidden\" class=\"commentId\" value=\"1\">\n" +
                        "            <span class=\"label label-info\">\n" +
                        "                <span class=\"glyphicon glyphicon-thumbs-up\"></span>\n" +
                        "                <span id=\"cLikeCount\">0</span>\n" +
                        "            </span>&nbsp;\n" +
                        "            <span class=\"label label-default\" onclick=\"secondaryComment(this)\">\n" +
                        "                <span class=\"glyphicon glyphicon-comment\"></span>\n" +
                        "                <span>0</span>\n" +
                        "            </span>\n" +
                        "            <span class=\"pull-right\">" + commentDate + "</span>\n" +
                        "        </span>\n" +
                        "    </div>\n" +
                        "</div>"
                    $("#commtentLevel2").append(objStr);
                }
            },
            error: function (response) {
            }
        })
    }


    //富文本编辑器,稍后整合
    var E = window.wangEditor;
    var editor = new E("#edit_description");
    editor.customConfig.debug = true;
    // 关闭粘贴内容中的样式
    editor.customConfig.pasteFilterStyle = false;
    // 忽略粘贴内容中的图片
    editor.customConfig.pasteIgnoreImg = false;
    // 上传图片到服务器
    editor.customConfig.uploadImgMaxSize = 3 * 1024 * 1024; // 将图片大小限制为 3M
    //自定义上传图片事件
    editor.customConfig.uploadImgHooks = {
        before: function (xhr, editor, files) {
        },
        success: function (xhr, editor, result) {
            console.log("上传成功");
        },
        fail: function (xhr, editor, result) {
            console.log("上传失败,原因是" + result);
        },
        error: function (xhr, editor) {
            console.log("上传出错");
        },
        timeout: function (xhr, editor) {
            console.log("上传超时");
        }
    }
    editor.create();

    $(".community-menu").click(function () {
        $.ajax({
            url: "management/getAllTagName",
            type: "GET",
            contentType: "application/json;charset=utf-8",
            success: function (response) {
                $("#edit_title").empty().val(titleVal);
                editor.txt.html(descriptionVal);
                var tabObj = $("#select_model");
                tabObj.empty();
                var tabStr = "";
                for (let i = 0; i < response.length; i++) {
                    var tag = response[i]
                    tabStr += "<option value=" + tag.typeId + ">" + tag.typeName + "</option>"
                }
                tabObj.append(tabStr)
                $("#select_model").find("option[value=" + ModelVal + "]").attr("selected", true)
            },
            error: function (response) {
            }
        })
    })

    $("#btn_submit2").click(function () {
        var titleVal = $("#edit_title").val();
        var descriptionVal = editor.txt.html();
        var date = new Date();
        var Month = date.getMonth() + 1;
        var createDate = date.getFullYear() + "-" + Month + "-" + date.getDate();
        var typeid = $("#select_model option:selected").val()
        var json = {
            id: id,
            title: titleVal,
            description: descriptionVal,
            typeid: typeid,
            createDate: createDate
        }
        var jsonStr = JSON.stringify(json)
        $.ajax({
            url: "publish/updateQuestion",
            type: "POST",
            data: jsonStr,
            contentType: "application/json;charset=utf-8",
            success: function (response) {
                if (response) {
                    swal({
                        text: "修改成功",
                        icon: "success",
                    });
                    refresh(id)
                }
            },
            error: function (response) {
                console.error(response)
            }
        })
    })

    /**
     * !$(objEle).is('.dz')判断是按钮是按下还是按起
     *
     * $(objEle).children().is('.glyphicon-thumbs-up')判断是‘顶’(true)还是‘踩’(false)
     * @param objEle
     */
    function like(objEle) {
        if ($(objEle).children().is('.glyphicon-thumbs-up')) {
            if (!$(objEle).is('.dz')) {
                if (addQuestionLikeCount()) {
                    $(objEle).css("opacity", 0.3).addClass("dz").siblings().css("opacity", 1.0).removeClass("dz")
                }
            } else {
                if (lessQuestionLikeCount()) {
                    $(objEle).css("opacity", 1.0).removeClass("dz").siblings().css("opacity", 1.0).removeClass("dz")
                }
            }
        } else {
            if (!$(objEle).is('.dz')) {
                if (lessQuestionLikeCount()) {
                    $(objEle).css("opacity", 0.3).addClass("dz").siblings().css("opacity", 1.0).removeClass("dz")
                }
            } else {
                if (addQuestionLikeCount()) {
                    $(objEle).css("opacity", 1.0).removeClass("dz").siblings().css("opacity", 1.0).removeClass("dz")
                }

            }
        }
    }

    function addQuestionLikeCount() {
        var flag = false;
        $.ajax({
            async: false,
            url: "publish/addQuestionLikeCount/" + id + "",
            type: "POST",
            contentType: "application/json;charset=utf-8",
            success: function (response) {
                flag = response
            }
        })
        return flag;
    }

    function lessQuestionLikeCount() {
        var flag = false;
        $.ajax({
            async: false,
            url: "publish/lessQuestionLikeCount/" + id + "",
            type: "POST",
            contentType: "application/json;charset=utf-8",
            success: function (response) {
                flag = response
            }
        })
        return flag;
    }

    //添加编辑权限
    function updateQuestion() {
        var objStr = "<a class=\"community-menu\" href=\"#myModal\" role=\"button\" data-toggle=\"modal\"\n" +
            "    data-target=\"#myModal\">\n" +
            "    <span class=\" glyphicon glyphicon-pencil\" aria-hidden=\"true\"> 编辑 </span>\n" +
            "</a>"
        if ($("#user_id").val() === $("#author_id").val()) {
            $("#updateQuestion").append(objStr)
        }
    }
</script>
</body>
</html>