<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <!-- 视窗配置 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 开启ie8的标准渲染模式 -->
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>晴天贴吧管理</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/htgl.css"/>
    <script src="js/jquery-3.3.1.min.js"></script>
    <link rel="stylesheet" href="dropzone/css/dropzone.min.css">
    <script src="dropzone/js/dropzone.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/Chart.min.js"></script>
    <style>
        #content .tbody{
            border: 0px;
        }
    </style>
</head>
<body>
<!-- 头部 -->
<script src="./js/backNavbar.js"></script>
<!-- 身体 -->
<section id="content">
    <div class="container">
        <div class="row">
            <!-- 左列表 -->
            <div class="col-md-3">
                <div class="list-group">
                    <a href="userManger.html" class="list-group-item">用户管理</a>
                    <a href="userSearch.html" class="list-group-item">用户搜索</a>
                    <a href="#myModal" class="list-group-item" role="button" data-toggle="modal" data-target="#myModal">添加用户</a>

                </div>
            </div>
            <!-- 右列表 -->
            <div class="col-md-9">
                <div class="page-header">
                    <h4>信息编辑</h4>
                </div>
                <div class="tbody">
                    <div class="col-lg-9 col-md-12 col-sm-12 col-xs-12">
                        <div class="mod-head">
                            <form class="form-horizontal" id="setting_form">
                                <input type="text" id="id" value="" hidden>
                                <div class="form-group">
                                    <label for="email">邮箱:</label>
                                    <input type="text" class="form-control" id="email"  value=""/>
                                </div>
                                <div class="form-group">
                                    <label for="accountname">昵称:</label>
                                    <input type="text" class="form-control" id="accountname"
                                           value=""/>
                                </div>
                                <div class="form-group">
                                    <label for="sginName">个性签名:</label>
                                    <input type="text" class="form-control" id="sginName"
                                           value=""/>
                                </div>
                                <div class="form-group">
                                    <label for="sex">性别:</label>
                                    <select id="sex" class="form-control">
                                        <option value="男">男</option>
                                        <option value="女">女</option>
                                        <option value="保密">保密</option>
                                    </select>
                                </div>
                                <!-- 上传头像 -->
                                <div class="form-group" style="float: right">
                                    <dl>
                                        <dt class="pull-left">
                                            <div id="avatar" style="background-image: url('./img/avatar-max-img.png');height: 100px;width: 100px;
                                            border-radius: 25px; background-size: cover;">
                                            </div>
                                        </dt>
                                        <dd class="pull-left">
                                            <p>支持 jpg、gif、png、jpeg 等格式的图片</p>
                                            <p>不超过为3MB</p>
                                            <label for="id_avatar"><img src="./img/picture.png" alt="图像加载失败"></label>
                                            <input type="text" id="id_avatar" name="file"
                                                   style="display:none">
                                        </dd>
                                    </dl>
                                </div>
                                <br>
                                <br>
                                <br>
                                <br>
                                <br>
                                <!-- end 上传头像 -->
                                <div class="form-group">
                                    <label for="input-qq">QQ</label>
                                    <input type="text" class="form-control" id="input-qq"
                                           value=""/>
                                </div>
                                <div class="form-group">
                                    <label for="input-wechat">微信:</label>
                                    <input type="text" class="form-control" id="input-wechat"/>
                                </div>
                                <div class="form-group">
                                    <label for="input-mobile">手机号码:</label>
                                    <input type="text" class="form-control" id="input-mobile" />
                                </div>
                                <div class="form-group">
                                    <label for="input-github">Github:</label>
                                    <input type="text" class="form-control" id="input-github" />
                                </div>
                                <div class="form-group">
                                    <label for="microblog">微博:</label>
                                    <input type="text" class="form-control" id="microblog"/>
                                </div>
                                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                                    <button type="button" class="btn btn-success btn-md" style="float: right"
                                            onclick="update()"
                                            id="submit">
                                        修改
                                    </button>
                                </div>
                            </form>
                        </div>
                        <!-- end 基本信息 -->
                        <!-- 联系方式 -->
                    </div>
                </div>
                </table>
            </div>
        </div>
    </div>
</section>

<!-- 添加用户弹出框 -->
<section class="footer">
    <div class="row  text-center">
        <div class="col-md-12">
            <strong>Copyright @ 晴天贴吧管理</strong>
        </div>
    </div>

</section>
<script>
    var params=window.location.search;
    var email=params.substr(params.indexOf("=")+1);
    $(function () {
        $(".text-center li").eq(1).addClass("active")
        refresh();
    })

    function refresh() {
        $.ajax({
            async:false,
            url: "user/getUserConfig?email=" + email,
            type: "GET",
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (response) {
                $("#email").val(response['email']);
                $("#accountname").val(response['accountName']);
                $("#status option[value='" + response['sex'] + "']").attr("selected", true);
                if (response['icon']!=null){
                    $("#avatar").css("background-image", "url(static/upload/" + response['icon'] + ")");
                }
                $("#sginName").val(response['sginName']);
                $("#input-qq").val(response['qq']);
                $("#input-wechat").val(response['weChat']);
                $("#input-mobile").val(response['mobile']);
                $("#input-github").val(response['github']);
                $("#microblog").val(response['microblog']);
            },
            error: function (response) {
            }
        })
    }
    Dropzone.autoDiscover = false;
    var fileName;
    var myDropzone = new Dropzone("#id_avatar", {
        url: "file/upload", // 文件提交地址
        method: "PUT",  // 也可用put
        paramName: "multipartFile", // 默认为file
        maxFiles: 1,// 一次性上传的文件数量上限
        maxFilesize: 3, // 文件大小，单位：MB
        acceptedFiles: ".jpg,.gif,.png,.jpeg", // 上传的类型
        addRemoveLinks: false,
        parallelUploads: 1,// 一次上传的文件数量
        // previewsContainer:"#avatar", // 上传图片的预览窗口
        dictDefaultMessage: '拖动文件至此或者点击上传',
        dictMaxFilesExceeded: "您最多只能上传1个文件！",
        dictResponseError: '文件上传失败!',
        dictInvalidFileType: "文件类型只能是*.jpg,*.gif,*.png,*.jpeg",
        dictFallbackMessage: "浏览器不受支持",
        dictFileTooBig: "文件过大上传文件最大支持.",
        dictRemoveLinks: "删除",
        dictCancelUpload: "取消",
        init: function () {
            this.on("addedfile", function (file) {
                // 上传文件时触发的事件
            });
            this.on("success", function (file, data) {
                // 上传成功触发的事件
                fileName = data.filename;
                $("#avatar").css("background-image", "url(static/upload/" + fileName + ")");
                updateIcon();
            });
            this.on("error", function (file, data) {
                // 上传失败触发的事件
                alert("请查看文件格式是否不支持！")
            });
            this.on("removedfile", function (file) {
                // 删除文件时触发的方法
            });
        }
    });

    /**
     *插入图标名至数据库，图标保存至本地
     */
    function updateIcon() {
        var json = {
            email: email,
            icon: fileName
        }
        var jsonStr = JSON.stringify(json);
        $.ajax({
            url: "file/updateIcon",
            type: "PUT",
            contentType: "application/json;charset=utf-8",
            data: jsonStr,
            success: function (response) {
            },
            error: function (response) {
                console.error(response)
            }

        })
    }

    function update() {
        var accountnameVal = $("#accountname").val();
        var sexVal = $('#sex option:selected').val();
        var sginNameVal = $("#sginName").val();
        var qqVal = $("#input-qq").val();
        var wechatVal = $("#input-wechat").val();
        var mobileVal = $("#input-mobile").val();
        var githubVal = $("#input-github").val();
        var microblogVal = $("#microblog").val();
        var json = {
            email: email,
            accountName: accountnameVal,
            sex: sexVal,
            sginName: sginNameVal,
            icon: fileName,
            qq: qqVal,
            weChat: wechatVal,
            mobile: mobileVal,
            github: githubVal,
            microblog: microblogVal
        }
        var jsonStr = JSON.stringify(json);
        $.ajax({
            async: false,
            url: "user/updateMassge",
            type: "PUT",
            contentType: "application/json;charset=utf-8",
            data: jsonStr,
            success: function (response) {
                alert("修改成功！")
            },
            error: function (response) {
                alert("修改失败！")
            }
        })
    }
</script>
</body>
</html>
